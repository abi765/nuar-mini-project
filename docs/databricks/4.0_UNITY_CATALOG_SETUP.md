# üî∑ Unity Catalog Setup Guide

## Issue: `UC_FILE_SCHEME_FOR_TABLE_CREATION_NOT_SUPPORTED`

If you're getting this error:
```
[UC_FILE_SCHEME_FOR_TABLE_CREATION_NOT_SUPPORTED] Creating table in Unity Catalog with file scheme dbfs is not supported.
```

**You're using Unity Catalog!** This is actually better - Unity Catalog provides better governance and security. You just need a slightly different setup.

---

## üéØ Quick Fix

### Use This File Instead:
**[databricks_notebooks/setup_delta_tables_unity_catalog.sql](../../databricks_notebooks/setup_delta_tables_unity_catalog.sql)**

This version:
- ‚úÖ Removes `LOCATION` clauses (Unity Catalog manages locations automatically)
- ‚úÖ Creates managed tables (better governance)
- ‚úÖ Works with Unity Catalog's storage management
- ‚úÖ Includes all Bronze, Silver, and Gold tables

---

## üîÑ What Changed?

### ‚ùå Old (Hive Metastore Style):
```sql
CREATE TABLE bronze.infrastructure (
  id BIGINT,
  ...
)
USING DELTA
LOCATION 'dbfs:/FileStore/nuar/bronze/infrastructure';  -- ‚ùå Not allowed in Unity Catalog
```

### ‚úÖ New (Unity Catalog Style):
```sql
CREATE TABLE bronze.infrastructure (
  id BIGINT,
  ...
)
USING DELTA;  -- ‚úÖ Unity Catalog manages location automatically
```

---

## üìã Setup Steps

### Step 1: Open the Unity Catalog SQL File

In Databricks:
1. Navigate to your Repos
2. Open: `/Repos/mnbabdullah765@yahoo.com/nuar_mini_project/databricks_notebooks/setup_delta_tables_unity_catalog.sql`
3. Attach to your cluster

### Step 2: Run All Cells

Execute the entire notebook. It will create:

**Bronze Tables:**
- ‚úÖ `bronze.infrastructure`
- ‚úÖ `bronze.crime`
- ‚úÖ `bronze.weather`
- ‚úÖ `bronze.postcodes`

**Silver Tables:**
- ‚úÖ `silver.infrastructure`
- ‚úÖ `silver.crime`
- ‚úÖ `silver.weather`
- ‚úÖ `silver.postcodes`

**Gold Tables:**
- ‚úÖ `gold.infrastructure_density` (placeholder)

### Step 3: Verify Tables Created

```sql
-- Check tables
SHOW TABLES IN nuar_catalog.bronze;
SHOW TABLES IN nuar_catalog.silver;

-- Verify structure
DESCRIBE EXTENDED nuar_catalog.bronze.infrastructure;
```

---

## üîç Understanding Unity Catalog

### Benefits

**Better Governance:**
- Fine-grained access control
- Audit logging
- Data lineage tracking
- Cross-workspace access

**Managed Storage:**
- Unity Catalog manages file locations
- Automatic cleanup
- Optimized storage paths
- No need to specify LOCATION

**Better Security:**
- Row-level and column-level security
- Dynamic views
- Credential management
- Cross-cloud support

---

## üìù Update Your Notebooks

Your notebooks may also need minor updates. When writing data:

### ‚ùå Old Way (with explicit location):
```python
df.write \
    .format("delta") \
    .mode("append") \
    .option("path", "dbfs:/FileStore/nuar/bronze/infrastructure") \
    .saveAsTable("nuar_catalog.bronze.infrastructure")
```

### ‚úÖ New Way (Unity Catalog):
```python
df.write \
    .format("delta") \
    .mode("append") \
    .saveAsTable("nuar_catalog.bronze.infrastructure")
```

Unity Catalog handles the storage location automatically!

---

## üîß Updating Databricks Settings

Your `config/databricks_settings.py` should detect Unity Catalog automatically:

```python
# Unity Catalog - no need for explicit paths
BRONZE_TABLES = {
    'infrastructure': f"{CATALOG_NAME}.bronze.infrastructure",
    'crime': f"{CATALOG_NAME}.bronze.crime",
    'weather': f"{CATALOG_NAME}.bronze.weather",
    'postcodes': f"{CATALOG_NAME}.bronze.postcodes"
}

# When writing data
spark_df.write \
    .format("delta") \
    .mode("append") \
    .saveAsTable(BRONZE_TABLES['infrastructure'])  # Unity Catalog manages location
```

---

## ‚úÖ Verification Checklist

After running the Unity Catalog setup:

- [ ] Run `setup_delta_tables_unity_catalog.sql` - All cells execute successfully
- [ ] Verify catalogs: `SHOW CATALOGS;` - `nuar_catalog` appears
- [ ] Verify schemas: `SHOW SCHEMAS IN nuar_catalog;` - bronze, silver, gold appear
- [ ] Verify Bronze tables: `SHOW TABLES IN nuar_catalog.bronze;` - 4 tables
- [ ] Verify Silver tables: `SHOW TABLES IN nuar_catalog.silver;` - 4 tables
- [ ] Check table details: `DESCRIBE EXTENDED nuar_catalog.bronze.infrastructure;`
- [ ] No `LOCATION` field in table metadata (Unity Catalog managed)

---

## üöÄ Next Steps

Once tables are created:

1. **Run Smoke Test:**
   - Open `databricks_notebooks/tests/smoke_test.py`
   - Should now pass catalog/schema checks

2. **Run Bronze Notebooks:**
   - `databricks_notebooks/bronze/01_bronze_infrastructure_full.py`
   - Data will write to managed Unity Catalog tables

3. **Verify Data:**
   ```sql
   SELECT COUNT(*) FROM nuar_catalog.bronze.infrastructure;
   ```

---

## üÜò Troubleshooting

### Still Getting Errors?

**Error: "Catalog not found"**
```sql
-- Create catalog first
CREATE CATALOG IF NOT EXISTS nuar_catalog;
USE CATALOG nuar_catalog;
```

**Error: "Schema not found"**
```sql
-- Create schemas
CREATE SCHEMA IF NOT EXISTS nuar_catalog.bronze;
CREATE SCHEMA IF NOT EXISTS nuar_catalog.silver;
CREATE SCHEMA IF NOT EXISTS nuar_catalog.gold;
```

**Error: "Permission denied"**
- You may need Unity Catalog admin permissions
- Ask your workspace admin to grant CREATE CATALOG permission
- Or use existing catalog: `hive_metastore` (default)

### Using Default Metastore Instead

If you don't have Unity Catalog permissions, use the default metastore:

```sql
-- Use default catalog
USE CATALOG hive_metastore;

-- Create database (instead of schema)
CREATE DATABASE IF NOT EXISTS nuar_bronze;
CREATE DATABASE IF NOT EXISTS nuar_silver;
CREATE DATABASE IF NOT EXISTS nuar_gold;

-- Create tables without explicit location
CREATE TABLE nuar_bronze.infrastructure (
  ...
) USING DELTA;
```

---

## üìä Unity Catalog vs Hive Metastore

| Feature | Unity Catalog | Hive Metastore |
|---------|---------------|----------------|
| **Access Control** | Fine-grained | Database-level |
| **Cross-workspace** | ‚úÖ Yes | ‚ùå No |
| **Audit Logging** | ‚úÖ Built-in | Limited |
| **Data Lineage** | ‚úÖ Automatic | Manual |
| **Location Management** | ‚úÖ Managed | Manual |
| **Best For** | Production, multi-team | Development, single workspace |

**Recommendation:** Use Unity Catalog if available - it's better for production!

---

## üìö Additional Resources

- **Unity Catalog Docs:** [https://docs.databricks.com/data-governance/unity-catalog/](https://docs.databricks.com/data-governance/unity-catalog/)
- **Managed Tables:** [https://docs.databricks.com/tables/managed.html](https://docs.databricks.com/tables/managed.html)
- **Migration Guide:** [https://docs.databricks.com/data-governance/unity-catalog/migrate.html](https://docs.databricks.com/data-governance/unity-catalog/migrate.html)

---

**Last Updated:** 2025-10-27
**Version:** 1.0
**Status:** ‚úÖ Unity Catalog Compatible

üéâ **Your setup is now Unity Catalog compatible!**
