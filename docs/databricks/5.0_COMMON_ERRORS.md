# üîß Common Databricks Errors & Solutions

Quick reference for common errors when running notebooks in Databricks.

---

## üî¥ Error: "ModuleNotFoundError: No module named 'databricks_settings'"

### Cause
Python kernel wasn't properly restarted after installing libraries.

### Solution

**Step 1: Run install + restart cells**
```python
# Cell 1
%pip install pyarrow geopandas pyproj shapely scipy python-dotenv requests

# Cell 2
dbutils.library.restartPython()
```

**Step 2: Wait for restart message**
You'll see: `"Python interpreter will be restarted"`

**Step 3: Continue manually**
After restart, **manually run** the remaining cells (or click "Run All Below")

‚ùå **DON'T:** Run all cells at once
‚úÖ **DO:** Run cells 1-2, wait, then run cells 3+

---

## üî¥ Error: "ModuleNotFoundError: No module named 'geopandas'"

### Cause
Libraries not installed or Python not restarted.

### Solution

Add these cells at the top of your notebook:
```python
# COMMAND ----------
%pip install geopandas pyproj shapely scipy python-dotenv requests pyarrow

# COMMAND ----------
dbutils.library.restartPython()
```

Then run manually after restart.

**Alternative:** Install via cluster libraries:
1. Go to cluster ‚Üí Libraries tab
2. Install all packages
3. Restart cluster
4. Remove pip install cells from notebooks

---

## üî¥ Error: "Repository not found at /Workspace/Repos/..."

### Cause
Wrong email in the path or Repos not synced.

### Solution

**Check your email:**
```python
# In Databricks, run this to see your email:
import getpass
print(getpass.getuser())
```

**Update path in notebooks:**
```python
# Change from:
sys.path.append('/Workspace/Repos/YOUR_EMAIL/nuar_mini_project')

# To (with your actual email):
sys.path.append('/Workspace/Repos/mnbabdullah765@yahoo.com/nuar_mini_project')
```

**Or sync Repos:**
1. Go to Repos in Databricks
2. Click your repo
3. Click "Pull" to sync from GitHub

---

## üî¥ Error: "UC_FILE_SCHEME_FOR_TABLE_CREATION_NOT_SUPPORTED"

### Cause
Using `LOCATION 'dbfs://...'` with Unity Catalog.

### Solution

Use the Unity Catalog compatible SQL file:
- ‚úÖ `databricks_notebooks/setup_delta_tables.sql` (Unity Catalog version)
- ‚ùå Don't use LOCATION clauses

See: [4.0_UNITY_CATALOG_SETUP.md](4.0_UNITY_CATALOG_SETUP.md)

---

## üî¥ Error: "Secret does not exist with scope: nuar_secrets"

### Cause
Secret scope not created or wrong scope name.

### Solution

**Create secret scope:**
```bash
# On your local machine:
databricks secrets create-scope --scope nuar_secrets
databricks secrets put --scope nuar_secrets --key openweather_api_key
```

**Verify secrets:**
```bash
databricks secrets list --scope nuar_secrets
```

**Check scope in code:**
```python
# Should match:
dbutils.secrets.get(scope="nuar_secrets", key="openweather_api_key")
```

---

## üî¥ Error: "HTTPSConnectionPool... Temporary failure in name resolution"

### Cause
Databricks cluster cannot access external internet (network/firewall restriction).

### Impact
- ‚ö†Ô∏è API tests will fail
- ‚ö†Ô∏è Bronze notebooks may fail

### Solutions

**Option 1: Run locally, upload data**
```bash
# On your laptop:
python notebooks/01_bronze_infrastructure_full.py
# Then upload data/bronze/ to Databricks
```

**Option 2: Contact admin**
Ask your Databricks admin to whitelist:
- `overpass-api.de`
- `data.police.uk`
- `api.postcodes.io`
- `api.openweathermap.org`

**Option 3: Ignore for now**
If only API tests fail but other tests pass (4/5), you can proceed with Silver layer (doesn't need APIs).

---

## üî¥ Error: "Catalog 'nuar_catalog' not found"

### Cause
Haven't run the Delta Lake setup SQL yet.

### Solution

Run `setup_delta_tables.sql`:
```sql
CREATE CATALOG IF NOT EXISTS nuar_catalog;
CREATE SCHEMA IF NOT EXISTS nuar_catalog.bronze;
CREATE SCHEMA IF NOT EXISTS nuar_catalog.silver;
CREATE SCHEMA IF NOT EXISTS nuar_catalog.gold;
```

---

## üî¥ Error: "Table already exists"

### Cause
Trying to create table that exists.

### Solution

**Check if table exists:**
```sql
SHOW TABLES IN nuar_catalog.bronze;
```

**Drop and recreate (if needed):**
```sql
DROP TABLE IF EXISTS nuar_catalog.bronze.infrastructure;
-- Then run CREATE TABLE again
```

**Or append data:**
```python
# Use mode="append" instead of creating table
df.write.mode("append").saveAsTable("nuar_catalog.bronze.infrastructure")
```

---

## üî¥ Error: "No module named 'dotenv'"

### Cause
`python-dotenv` package not installed.

### Solution

Install it:
```python
%pip install python-dotenv
dbutils.library.restartPython()
```

**Note:** After restart, continue from next cell manually!

---

## üî¥ Error: "ImportError: No module named 'config'"

### Cause
sys.path not set before importing.

### Solution

Add this BEFORE any config imports:
```python
import sys
sys.path.append('/Workspace/Repos/YOUR_EMAIL/nuar_mini_project')

# THEN import:
from config.databricks_settings import *
```

---

## üî¥ Warning: "Can't uninstall 'numpy'"

### Not an error!
This warning is normal - Databricks can't uninstall system packages but will use the new version.

Just ignore this warning:
```
Not uninstalling numpy at /databricks/python3/lib/python3.10/site-packages
Can't uninstall 'numpy'. No files were found to uninstall.
```

---

## üîç General Troubleshooting Steps

### 1. Check Current Working Directory
```python
import os
print(f"Current dir: {os.getcwd()}")
print(f"Files: {os.listdir('.')}")
```

### 2. Check sys.path
```python
import sys
print("Python path:")
for p in sys.path:
    print(f"  {p}")
```

### 3. Verify Repos Location
```python
import os
repo_path = '/Workspace/Repos/YOUR_EMAIL/nuar_mini_project'
print(f"Repo exists: {os.path.exists(repo_path)}")
if os.path.exists(repo_path):
    print(f"Contents: {os.listdir(repo_path)}")
```

### 4. Check Python Version
```python
import sys
print(f"Python: {sys.version}")
```

### 5. List Installed Packages
```python
!pip list | grep -E "geopandas|pyproj|shapely|scipy"
```

---

## üìã Pre-Run Checklist

Before running any notebook:

- [ ] Cluster is running
- [ ] Repos synced from GitHub (pulled latest)
- [ ] Correct email in sys.path.append()
- [ ] Libraries installed (via cluster or %pip)
- [ ] Secrets configured (if using APIs)
- [ ] Delta tables created (for Silver/Gold)

---

## üÜò Still Stuck?

### Check These Docs

1. **[0.0_START_HERE.md](0.0_START_HERE.md)** - Pre-deployment checklist
2. **[1.0_QUICKSTART_GUIDE.md](1.0_QUICKSTART_GUIDE.md)** - Step-by-step deployment
3. **[4.0_UNITY_CATALOG_SETUP.md](4.0_UNITY_CATALOG_SETUP.md)** - Unity Catalog issues
4. **[2.0_COMPLETE_MIGRATION_GUIDE.md](2.0_COMPLETE_MIGRATION_GUIDE.md)** - Full troubleshooting

### Debug Pattern

1. **Isolate the issue** - Which cell fails?
2. **Check error message** - Match to this guide
3. **Test prerequisites** - Are libs installed? Repos synced?
4. **Try workaround** - Run locally if needed
5. **Document solution** - Help future you!

---

**Last Updated:** 2025-10-27
**Version:** 1.0

üéØ **Most common fix:** Run install cells, wait for restart, then continue manually!
